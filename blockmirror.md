mirror\_start\_job: first choose the right copy granularity\(align to block device cluster\). Initialize the BlockJob struct. BlockJob is async the callback is set by BlockCompletionFunc \*cb.  Use bs-&gt;open\_flags \|= BDRV\_O\_CACHE\_WB to enable target cache. create the mirror coroutine and enter to it. coroutine function is mirror\_run.

mirror\_run: Get block length.  A in\_flight\_bitmap will be created, and the bitmap length will equal to the UP\_ROUND\(block\_length\_by\_byte \/ granularity\). Create a cow\_bitmap whose length is equal to in\_flight\_bitmap. BlockJob buffer size must be bigger than cluster\_size. Create buf which is aligned by buf\_size. Set all alocated sector as dirty, the dirty\_map length is equal to number of sectors. After the dirty\_map is setup we could now move the source block to the buffer. First calculate the length of the left bytes. s-&gt;common.offset + \(cnt\(dirty sector numbers\) + s-&gt;sectors\_in\_flight\) \* BDRV\_SECTOR\_SIZE;  enter mirror\_iteration to copy data. If no buffer or will exceed max inflight bytes, do coroutine yield. If no in\_flight or no dirty, flush data to target. mirror\_run will competed after should\_complete is true and dirty sector number is 0. Or user cancel the mirror.

mirror\_iteration: if we have enough buffer, then read as many dirty pages as we can. and set these chunch dirty in the in\_flight\_bitmap. After the aio read is completed. mirror\_read\_complete will be called by aio and this function only calls bdrv\_aio\_writev which will write the in flight content to the target and set the call back as mirror\_write\_complete. After the write is completed the written part of the bit set in in\_flight\_bitmap will be cleared and the buffer will be freed.

mirror\_complete: If the user cancel\/stop the block job, this function will be called. It will block all disk operation and set the should\_complete to true.

mirror\_exit: After mirror\_run is completed, mirror\_exit will called which will swap the source and target disks. And then it will unblock all disk operations.

